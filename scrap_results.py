import os
import requests

departements = {
    "/84/01/": "01 - Ain",
    "/32/02/": "02 - Aisne",
    "/84/03/": "03 - Allier",
    "/93/04/": "04 - Alpes-de-Haute-Provence",
    "/93/05/": "05 - Hautes-Alpes",
    "/93/06/": "06 - Alpes-Maritimes",
    "/84/07/": "07 - Ardèche",
    "/44/08/": "08 - Ardennes",
    "/76/09/": "09 - Ariège",
    "/44/10/": "10 - Aube",
    "/76/11/": "11 - Aude",
    "/76/12/": "12 - Aveyron",
    "/93/13/": "13 - Bouches-du-Rhône",
    "/28/14/": "14 - Calvados",
    "/84/15/": "15 - Cantal",
    "/75/16/": "16 - Charente",
    "/75/17/": "17 - Charente-Maritime",
    "/24/18/": "18 - Cher",
    "/75/19/": "19 - Corrèze",
    "/27/21/": "21 - Côte-d'Or",
    "/53/22/": "22 - Côtes-d'Armor",
    "/75/23/": "23 - Creuse",
    "/75/24/": "24 - Dordogne",
    "/27/25/": "25 - Doubs",
    "/84/26/": "26 - Drôme",
    "/28/27/": "27 - Eure",
    "/24/28/": "28 - Eure-et-Loir",
    "/53/29/": "29 - Finistère",
    "/94/2A/": "2A - Corse-du-Sud",
    "/94/2B/": "2B - Haute-Corse",
    "/76/30/": "30 - Gard",
    "/76/31/": "31 - Haute-Garonne",
    "/76/32/": "32 - Gers",
    "/75/33/": "33 - Gironde",
    "/76/34/": "34 - Hérault",
    "/53/35/": "35 - Ille-et-Vilaine",
    "/24/36/": "36 - Indre",
    "/24/37/": "37 - Indre-et-Loire",
    "/84/38/": "38 - Isère",
    "/27/39/": "39 - Jura",
    "/75/40/": "40 - Landes",
    "/24/41/": "41 - Loir-et-Cher",
    "/84/42/": "42 - Loire",
    "/84/43/": "43 - Haute-Loire",
    "/52/44/": "44 - Loire-Atlantique",
    "/24/45/": "45 - Loiret",
    "/76/46/": "46 - Lot",
    "/75/47/": "47 - Lot-et-Garonne",
    "/76/48/": "48 - Lozère",
    "/52/49/": "49 - Maine-et-Loire",
    "/28/50/": "50 - Manche",
    "/44/51/": "51 - Marne",
    "/44/52/": "52 - Haute-Marne",
    "/52/53/": "53 - Mayenne",
    "/44/54/": "54 - Meurthe-et-Moselle",
    "/44/55/": "55 - Meuse",
    "/53/56/": "56 - Morbihan",
    "/44/57/": "57 - Moselle",
    "/27/58/": "58 - Nièvre",
    "/32/59/": "59 - Nord",
    "/32/60/": "60 - Oise",
    "/28/61/": "61 - Orne",
    "/32/62/": "62 - Pas-de-Calais",
    "/84/63/": "63 - Puy-de-Dôme",
    "/75/64/": "64 - Pyrénées-Atlantiques",
    "/76/65/": "65 - Hautes-Pyrénées",
    "/76/66/": "66 - Pyrénées-Orientales",
    "/44/67/": "67 - Bas-Rhin",
    "/44/68/": "68 - Haut-Rhin",
    "/84/69/": "69 - Rhône",
    "/27/70/": "70 - Haute-Saône",
    "/27/71/": "71 - Saône-et-Loire",
    "/52/72/": "72 - Sarthe",
    "/84/73/": "73 - Savoie",
    "/84/74/": "74 - Haute-Savoie",
    "/11/75/": "75 - Paris",
    "/28/76/": "76 - Seine-Maritime",
    "/11/77/": "77 - Seine-et-Marne",
    "/11/78/": "78 - Yvelines",
    "/75/79/": "79 - Deux-Sèvres",
    "/32/80/": "80 - Somme",
    "/76/81/": "81 - Tarn",
    "/76/82/": "82 - Tarn-et-Garonne",
    "/93/83/": "83 - Var",
    "/93/84/": "84 - Vaucluse",
    "/52/85/": "85 - Vendée",
    "/75/86/": "86 - Vienne",
    "/75/87/": "87 - Haute-Vienne",
    "/44/88/": "88 - Vosges",
    "/27/89/": "89 - Yonne",
    "/27/90/": "90 - Territoire de Belfort",
    "/11/91/": "91 - Essonne",
    "/11/92/": "92 - Hauts-de-Seine",
    "/11/93/": "93 - Seine-Saint-Denis",
    "/11/94/": "94 - Val-de-Marne",
    "/11/95/": "95 - Val-d'Oise",
    "/01/971/": "971 - Guadeloupe",
    "/02/972/": "972 - Martinique",
    "/03/973/": "973 - Guyane",
    "/04/974/": "974 - La Réunion",
    "/./975/": "975 - Saint-Pierre-et-Miquelon",
    "/06/976/": "976 - Mayotte",
    "/./986/": "986 - Wallis et Futuna",
    "/./987/": "987 - Polynésie française",
    "/./988/": "988 - Nouvelle-Calédonie",
    "/./ZX/": "ZX - Saint-Martin/Saint-Barthélemy",
    "/./ZZ/": "ZZ - Français établis hors de France",
}

cookies = {
    'incap_ses_1516_651915': 'PIhTHAC5IHnSqlFxCuoJFZ/NgWYAAAAA1k9s6ondNVcr9M3pHirQyA==',
    'visid_incap_651915': 'MK7ETqv5TWyyawABVrhDoZ/NgWYAAAAAQUIPAAAAAAApRZ/4MZNng2t7NYrpzWIA',
    'nlbi_651915': 'gynLdaCZyV0mbh6/WaZYiwAAAADc37bIjM+B47b0yBTt7EnJ',
    'incap_ses_467_651915': '+Fv7KpJx3HBZ3ws3IB57BqBXgmYAAAAAc+L8z8/gFgAYIPdsi6gMfQ==',
    'incap_ses_2222_651915': '9jUUA5MDqB2uQk6JZiHWHqBXgmYAAAAAsFegOQ+a2RZWYqZPs4zFfQ==',
    'incap_ses_1173_651915': 'QE9SbJ+YODayk879XVVHEKBXgmYAAAAAIgIwN244qP0a8kOPQmz9kw==',
    'incap_ses_189_651915': 'pTq3PxYtnX5g6BtImXafAqNXgmYAAAAADpgAzyW+8e3p4OzPV/DYXw==',
    'incap_ses_2224_651915': 'qTYhSO1kuxooqUA4SjzdHqRXgmYAAAAA6+16IADVObekP2wKLUu37w==',
    'incap_ses_2223_651915': 'UMSlfkxY+ldA9FE40K7ZHqZXgmYAAAAAMCfup4bl70/ZUfPpvmbEBg==',
    'incap_ses_391_651915': 'CXw+TGg6s2BtoVmlghxtBaZXgmYAAAAAdp67BMybXKlRJ5p3y2dU9A==',
    'etuix': 'T1ICqSlQ8dcyobS1MKWyOktcM.Z55vtOuLaXGEEyp9u3dMQrmZQ_CQ--',
    'incap_ses_464_651915': '8yhPS00wtUhj+y1HpHVwBrlXgmYAAAAAihUa8q5xFQ7EeglbimNSOw==',
}

headers = {
    'accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
    'accept-language': 'fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7,es;q=0.6',
    'cache-control': 'no-cache',
    'pragma': 'no-cache',
    'priority': 'u=0, i',
    'referer': 'https://www.resultats-elections.interieur.gouv.fr/legislatives2024/ensemble_geographique/986/index.html',
    'sec-ch-ua': '"Not/A)Brand";v="8", "Chromium";v="126", "Google Chrome";v="126"',
    'sec-ch-ua-mobile': '?0',
    'sec-ch-ua-platform': '"Windows"',
    'sec-fetch-dest': 'document',
    'sec-fetch-mode': 'navigate',
    'sec-fetch-site': 'same-origin',
    'sec-fetch-user': '?1',
    'upgrade-insecure-requests': '1',
    'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36',
}

last_circo = {
    "01": 6,
    "02": 6,
    "03": 4,
    "04": 3,
    "05": 3,
    "06": 10,
    "07": 4,
    "08": 4,
    "09": 3,
    "10": 4,
    "11": 4,
    "12": 4,
    "13": 17,
    "14": 7,
    "15": 3,
    "16": 4,
    "17": 6,
    "18": 4,
    "19": 3,
    "21": 6,
    "22": 6,
    "23": 2,
    "24": 5,
    "25": 6,
    "26": 5,
    "27": 6,
    "28": 5,
    "29": 9,
    "2A": 3,
    "2B": 3,
    "30": 7,
    "31": 11,
    "32": 3,
    "33": 13,
    "34": 10,
    "35": 9,
    "36": 3,
    "37": 6,
    "38": 11,
    "39": 4,
    "40": 4,
    "41": 4,
    "42": 7,
    "43": 3,
    "44": 11,
    "45": 7,
    "46": 3,
    "47": 4,
    "48": 2,
    "49": 8,
    "50": 5,
    "51": 6,
    "52": 3,
    "53": 4,
    "54": 7,
    "55": 3,
    "56": 7,
    "57": 10,
    "58": 3,
    "59": 22,
    "60": 8,
    "61": 4,
    "62": 13,
    "63": 6,
    "64": 7,
    "65": 3,
    "66": 5,
    "67": 10,
    "68": 7,
    "69": 15,
    "70": 3,
    "71": 6,
    "72": 6,
    "73": 5,
    "74": 7,
    "75": 19,
    "76": 11,
    "77": 12,
    "78": 13,
    "79": 4,
    "80": 6,
    "81": 4,
    "82": 3,
    "83": 9,
    "84": 6,
    "85": 6,
    "86": 5,
    "87": 4,
    "88": 5,
    "89": 4,
    "90": 3,
    "91": 11,
    "92": 14,
    "93": 13,
    "94": 12,
    "95": 11,
    "971": 5,
    "972": 5,
    "973": 3,
    "974": 8,
    "975": 2,
    "976": 3,
    "986": 2,
    "987": 4,
    "988": 3,
    "ZX": 2,
    "ZZ": 12,
}


def scrap_results(dpt_url, dpt_name):
    circo = 0
    dpt_code, dpt_name = dpt_name.split(" - ")

    while True:
        circo += 1
        if last_circo[dpt_code] == circo:
            break
        file_path = f"./results_html/{dpt_code}_{circo}.html"
        if os.path.exists(file_path):
            continue
        circo_pad = str(circo).zfill(2)
        results_url = f"https://www.resultats-elections.interieur.gouv.fr/legislatives2024/ensemble_geographique{dpt_url}/{dpt_code}{circo_pad}/index.html"

        response = requests.get(results_url, cookies=cookies, headers=headers)
        if response.status_code == 404:
            print(f"{dpt_code}: {circo},")
            break
        if response.status_code != 200:
            print(f"Error {response.status_code} for {results_url}")
            continue

        with open(file_path, "wb") as f:
            f.write(response.content)


if __name__ == "__main__":
    for url, departement in departements.items():
        scrap_results(url, departement)
